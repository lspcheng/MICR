---
title: "MICR AXB Combined Statistics"
output: html_notebook
---
# Set up
## Packages
```{r, warning=F}
# Wrangling
library(tidyverse)
library(mgsub)

# Statistics/Numerical processing
library(lme4)
library(brms)
library(boot)

# Plotting
library(ggplot2)
library(ghibli)

# Optional settings
options(dplyr.summarise.inform=F) # Stop dplyr from printing summarise error (that isn't an error)
select <- dplyr::select # Ensure that select() command is the dplyr command (clashes with MASS, which is imported/required by paran)
```

## Functions
```{r, warning=F}
# Standard error function
std.error <- function(x, na.rm = T) {
  sqrt(var(x, na.rm = na.rm)/length(x[complete.cases(x)]))
}

# general standardized ggplot theme
gg_theme <- function() {
  theme_bw() +
  theme(plot.title=element_text(size=25),
        plot.subtitle=element_text(size=15, face="italic"),
        axis.title=element_text(size=20),
        axis.text=element_text(size=15),
        strip.background =element_rect(fill="white"),
        strip.text = element_text(size=15))+
  theme(legend.title = element_text(size=15, face="bold"),
        legend.text=element_text(size=15))
}

# color theme for guise plots
guise_colors <- function(gg_object, n_contrasts) {
  if (n_contrasts == 3) {
    col_values <- c(6,4,3)
  } else if (n_contrasts == 2) {
    col_values <- c(4,3)
  } else {
    return(print('Number of contrasts invalid: Must be either 3 or 2'))
  }
  
   return (
      gg_object +
        scale_fill_manual(values=ghibli_palette("PonyoMedium")[col_values])+
        scale_color_manual(values=ghibli_palette("PonyoMedium")[col_values])
    )
}

# color theme and labels for interaction plots
interaction_plot_theme <- function(gg_object, n_contrasts) {
    if (n_contrasts == 3) {
      col_values <- c(7,6,5)
  } else if (n_contrasts == 4) {
    col_values <- c(7,6,5,2)
  } else {
    return(print('Number of contrasts invalid: Must be either 3 or 4'))
  }
  return(
      gg_object +
        gg_theme() +
        scale_color_manual(values=ghibli_palette("MononokeMedium")[col_values])+
        scale_fill_manual(values=ghibli_palette("MononokeMedium")[col_values])+
        scale_shape_manual(values=c(16,15,17,18))+
        scale_linetype_manual(values=c("solid", "longdash", "dashed", "dotted"))+
        labs(y = 'Guise Effect', x = 'Stereotype Familiarity', 
             color = 'Empathy Quotient', fill = 'Empathy Quotient', 
             shape = 'Empathy Quotient', linetype = 'Empathy Quotient')
    )
}

## theme for pca plots
pca_plot_theme <- function(gg_object) {
  gg_object +
  gg_theme() +
  scale_x_continuous(lim=c(-3, 3),breaks=seq(-3,3,1)) +
  scale_y_continuous(lim=c(-3.5, 3.5),breaks=seq(-3,3,1)) +
  geom_hline(yintercept=0, linetype="dashed") +
  geom_vline(xintercept=0, linetype="dashed") +
  labs(x="Dim 1 (XX.X%)", y="Dim 2 (XX.X%)")
}

## theme for proportion plots
proportion_plot_theme <- function(gg_object) {
  gg_object %>% guise_colors(3) +
  gg_theme() +
  coord_cartesian(ylim=c(0, 1)) +
  scale_x_continuous(breaks = -3:3) +
  labs(y = "Proportion 'raised' response", x = "Continuum Step (UR to RS)", 
       color="Guise", fill="Guise", linetype = "Guise")
}
```

# Data Preparation

```{r}
# Load combined dataset as "axb_all_data" dataframe
load("./data/axb_combined_data.rData")

axb_data_coded <- axb_all_data %>% filter(speaker=='S3') %>%
  
  # Treatment/Baseline coding (compare to reference group)
  mutate(guiseCN=case_when(speakerGuise=='CN' ~ 1,
                         TRUE~0),
        guiseMI=case_when(speakerGuise=='MI' ~ 1,
                         TRUE~0),
        
        # Deviation/Contrast coding (compare MI to CN)
        guiseContr=case_when(speakerGuise=='CN' ~ -1,
                             speakerGuise=='MI' ~ 1,
                             TRUE~0),
        genderContr = case_when(Gender=='f' ~ -1,
                                 Gender=='m' ~ 1,
                                 TRUE ~ 0)) %>%
  mutate(across(where(is.character), as.factor)) %>%
  mutate(across(where(is.matrix), as.vector)) %>%
  select(experimentId, participantId, speakerGuise, Age, Gender, CEscore_all:EQscore_all, 
         step, vowel, word, order, respRS, rt, guiseCN, guiseMI, guiseContr, genderContr)

colnames(axb_data_coded)
axb_data_coded

au_data_coded <- filter(axb_data_coded, vowel=='AU')
ai_data_coded <- filter(axb_data_coded, vowel=='AI')
```

#...
# /au/
## Continuous Step Regression
### Frequentist (glmer)

#### Models
```{r include=F}
# guiseCN + guiseMI: Base Model for extracting fixed effects and model coefficients (BL vs CN & MI)
cont_au_glm <- glmer(respRS ~ step + guiseCN + guiseMI + step:guiseCN + step:guiseMI +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
summary(cont_au_glm)
```


```{r}
# speakerGuise: Base Model for extracting fixed effects and model coefficients (BL vs CN & MI)
cont_au_glm_base <- glmer(respRS ~ step + speakerGuise + step:speakerGuise +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
summary(cont_au_glm_base)
```


```{r}
# No-interaction Model
cont_au_glm_base2 <- glmer(respRS ~ step + speakerGuise  +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
anova(cont_au_glm_base2, cont_au_glm_base)

# No-Guise Model
cont_au_glm_base3 <- glmer(respRS ~ step  +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
anova(cont_au_glm_base3, cont_au_glm_base2)
```

```{r}
# speakerGuise: Releveled Comparison: CN guise vs. MI guise
au_data_coded$guiseRelvl = relevel(au_data_coded$speakerGuise, ref="CN")

# Max Model
cont_au_glm_relvl <- glmer(respRS ~ step + guiseRelvl + step:guiseRelvl +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
summary(cont_au_glm_relvl)
```


```{r}
# No-interaction Model
cont_au_glm_relvl2 <- glmer(respRS ~ step + guiseRelvl  +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
anova(cont_au_glm_relvl2, cont_au_glm_relvl)

# No-guise Model
cont_au_glm_relvl3 <- glmer(respRS ~ step  +
                       (1 | participantId) + (0 + step | participantId) +
                       (1 | word) + (0 + step | word),
                    family = "binomial", 
                    control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                    data = au_data_coded
                    ) 
anova(cont_au_glm_relvl3, cont_au_glm_relvl2)
```


#### Extract Group Estimates
```{r}
# Check intercept values
( fixef_au <- fixef(cont_au_glm_base) )

# Calculate intercepts per guise
( int_bl <- fixef_au[[1]] )
( int_cn <- int_bl + fixef_au[[3]] )
( int_mi <- int_bl + fixef_au[[4]] )

# Calculate slopes per guise
( slope_bl <- fixef_au[[2]] )
( slope_cn <- slope_bl + fixef_au[[5]] )
( slope_mi <- slope_bl + fixef_au[[6]] )

# Calculate x-intercepts per guise, i.e., where y=0, using the formula [y = ax + b]  ~  [x = -b/a]
( xint_bl = -(int_bl / slope_bl) )
( xint_cn = -(int_cn / slope_cn) )
( xint_mi = -(int_mi / slope_mi) )

```

```{r}
# Double check intercept values to guise means
au_data_coded %>% group_by(speakerGuise) %>%
  summarize(propRS = mean(respRS), logOddsRS = logit_scaled(mean(respRS))) %>%
  mutate(intercepts = c(int_bl, int_cn, int_mi),
         slopes = c(slope_bl, slope_cn, slope_mi)) %>%
  mutate(mean_int_diff = intercepts - logOddsRS)

```

#### Prediction Plots
```{r}
# Predict on all unique combinations (Option 1)
cont_au_pred <- 
  expand.grid(
    participantId = NA,
    word = NA,
    step = unique(au_data_coded$step),
    speakerGuise = unique(au_data_coded$speakerGuise)
  )
cont_au_pred
  
cont_au_pred$pred_logOdds <- predict(cont_au_glm_base, newdata=cont_au_pred, type = "link", re.form=NA)
cont_au_pred$pred_prop <- predict(cont_au_glm_base, newdata=cont_au_pred, type = "response", re.form=NA)

cont_au_pred %>% ggplot(aes(x=step, y=pred_logOdds, color=speakerGuise)) %>% 
  guise_colors(3) +
  theme_minimal() +
  geom_smooth(method="glm", formula = 'y ~ x') +
  # geom_smooth(method="loess") +
  geom_point(alpha=0.8) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")

# TODO: add jittered points in the back? maybe switch to actual data with variation
au_pred_plot <-
cont_au_pred %>% ggplot(aes(x=step, y=pred_prop, color=speakerGuise, fill=speakerGuise, linetype=speakerGuise)) %>% 
  proportion_plot_theme() +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  coord_cartesian(ylim = c(0.15, 0.85)) + 
  geom_smooth(method="loess", alpha=0.3) +
  geom_point(alpha=0.8) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")
au_pred_plot

# ggsave(path="plots", filename="au_group_prop_pred.png", au_pred_plot, width=12, height=8, units = "in" , dpi=72)
```

```{r include=T}
# Predict on original/actual data (Option 2: LogOdds)
cont_au_pred_actual <- au_data_coded %>%
  mutate(predictions =  predict(cont_au_glm_base, type = "link") )

cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, color=speakerGuise)) %>% 
  guise_colors(3) +
  theme_minimal() +
  geom_smooth(method="glm", se=T) +
  # geom_point(alpha=0.1) +
  geom_vline(xintercept = xint_bl) +
  geom_vline(xintercept = xint_cn) +
  geom_vline(xintercept = xint_mi) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")

```

```{r include=T}
# Predict on original/actual data (Option 2: Proportions)
cont_au_pred_actual <-  au_data_coded %>%
  mutate(predictions =  predict(cont_au_glm_base, type = "response") )

au_pred_plot <-
cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, 
                                   color=speakerGuise, fill=speakerGuise, linetype=speakerGuise)) %>% 
  proportion_plot_theme() +
  facet_grid(~vowel) +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  coord_cartesian(ylim = c(0.15, 0.85)) + 
  geom_smooth(method="loess", se=T, alpha=0.5)
au_pred_plot

ggsave(path="plots", filename="au_group_prop_nocross_pred.png", au_pred_plot, width=12, height=8, units = "in" , dpi=72)

au_pred_plot <-
cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, 
                                   color=speakerGuise, fill=speakerGuise, linetype=speakerGuise)) %>% 
  proportion_plot_theme() +
  facet_grid(~vowel) +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  coord_cartesian(ylim = c(0.15, 0.85)) + 
  geom_smooth(method="loess", se=T, alpha=0.5) +
  # geom_point(alpha=0.1) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")
au_pred_plot

ggsave(path="plots", filename="au_group_prop_cross_pred.png", au_pred_plot, width=12, height=8, units = "in" , dpi=72)
```


# .
## Coef Ind Regression
### Extract Individual Estimates
For these calculations:
* yint_bl = Intercept
* slope_bl = step
* yint_cn = Intercept + guiseCN
* slope_cn = step + step.guiseCN
* xint_bl = yint_bl / slope_bl
* xint_cn = yint_cn / slope_cn

```{r}
# Extract individual coefficients (based on random effects)
ranef_au <- ranef(cont_au_glm_base)[1] # raw adjustment values
coef_au <- coef(cont_au_glm_base)[1] # individual co-efficients (adjustments already applied)

# Process coefficients
coef_au <-
  data.frame(coef_au) %>% rownames_to_column("participantId") %>% 
  rename_with( ~gsub("participantId.","", .x), starts_with("participantId.")) %>%
  rename_with( ~gsub("^\\.|\\.$","", .x)) %>%
  
  # Calculate xints per guise per individual (i.e., predicted patterns per guises that they didn't see)
  mutate(xint_bl = -(Intercept / step),
         xint_cn = -((Intercept + speakerGuiseCN) / (step + step.speakerGuiseCN)),
         xint_mi = -((Intercept + speakerGuiseMI) / (step + step.speakerGuiseMI)))
```

```{r}
xints_coef_au <-
  coef_au %>% select(participantId, xint_bl, xint_cn, xint_mi) %>%
  pivot_longer(., xint_bl:xint_mi, names_to="guise_pred", names_prefix="xint_", values_to="xint_pred", 
               names_transform = list(guise_pred = toupper)) %>%
  mutate_if(is.character,as.factor)
xints_coef_au
```

#### Exploratory Plots (1)

```{r}
xints_coef_au %>%
 ggplot(aes(y=participantId, x=xint_pred, color=guise_pred)) %>% 
  guise_colors(3) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  xlim(-2,2) +
  geom_vline(xintercept = xint_bl) +
  geom_vline(xintercept = xint_cn) +
  geom_vline(xintercept = xint_mi) +
  geom_point(alpha=0.8)  

```

```{r}
xints_coef_au %>% ggplot(aes(y=xint_pred, x=guise_pred, color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_jitter(alpha=0.5) +
  geom_boxplot(alpha=0.8)
  
xints_coef_au %>% ggplot(aes(x=xint_pred, y=reorder(guise_pred, desc(guise_pred)), color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  labs(y="guise_pred") +
  coord_cartesian(xlim=c(-3, 3)) +
  geom_jitter(alpha=0.3) +
  geom_boxplot(alpha=0.8)
  # geom_violin(alpha=0.8)

  
```

### Process Data + Outliers
```{r include=F}
# Calculate RT score per participant
rtscores <- au_data_coded %>% group_by(participantId) %>% 
  summarize(meanRT = mean(log(rt))) %>% ungroup() %>% 
  mutate(RTscore = as.vector(scale(meanRT)))
```

#### Full
```{r}
Q1 <- quantile(xints_coef_au$xint_pred, .25)
Q3 <- quantile(xints_coef_au$xint_pred, .75)
IQR <- IQR(xints_coef_au$xint_pred)

au_data_ind_coef_max <- au_data_coded %>% select(-step:-rt) %>%
  merge(., xints_coef_au) %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_noBL_max <- au_data_ind_coef_max %>% filter(speakerGuise!='BL')
```

#### Reduced
```{r}
Q1 <- quantile(xints_coef_au$xint_pred, .25)
Q3 <- quantile(xints_coef_au$xint_pred, .75)
IQR <- IQR(xints_coef_au$xint_pred)

au_data_ind_coef <- au_data_coded %>% select(-step:-rt) %>%
  merge(., xints_coef_au) %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  filter(xint_pred > Q1-IQR*1.5 & xint_pred < Q3+IQR*1.5) %>%

  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_noBL <- au_data_ind_coef %>% filter(speakerGuise!='BL')
  
summary(au_data_ind_coef)
au_data_ind_coef
au_data_ind_coef_noBL
```


```{r}
# Check Data numbers
au_data_ind_coef %>% group_by(experimentId, speakerGuise) %>% count() %>%
  merge(., au_data_ind_coef %>% 
          group_by(experimentId, speakerGuise) %>% 
          summarize(across(where(is.numeric), mean))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)

au_data_ind_coef %>% group_by(speakerGuise) %>% count() %>%
  merge(., au_data_ind_coef %>% 
          group_by(speakerGuise) %>% 
          summarize(across(where(is.numeric), mean))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)
```

```{r}
# Check BL removals
setdiff(au_data_ind_coef, au_data_ind_coef_noBL) %>% select(-Age:-xint_pred)
```

```{r}
# Check outlier removals
setdiff(au_data_ind_coef_max, au_data_ind_coef) %>% select(-Age:-xint_pred)
```

#### Exploratory Plots (2)
```{r}
au_data_ind_coef %>% 
 ggplot(aes(x=xint_pred, fill=speakerGuise, color=speakerGuise)) %>%
  guise_colors(3) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  geom_density(alpha=0.4, binwidth=0.1)
```

```{r}

xint_distribution <-
au_data_ind_coef %>% ggplot(aes(y=xint_pred, x=speakerGuise, color=speakerGuise, fill=speakerGuise)) %>%
  guise_colors(3) +
  labs(x='Guise', y='Crossover Point', color='Guise', fill='Guise') +
  gg_theme() +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(-1, 1)) +
  geom_point(alpha=0.3) +
  geom_boxplot(alpha=0.3)
xint_distribution
ggsave(path="plots", filename="au_ind_crosspoint_coef_pred.png", xint_distribution, width=8, height=8, units = "in" , dpi=72)

xint_distribution <-
au_data_ind_coef %>% ggplot(aes(y=guiseShift, x=speakerGuise, color=speakerGuise, fill=speakerGuise)) %>%
  guise_colors(3) +
  labs(x='Guise', y='Guise Effect', color='Guise', fill='Guise') +
  gg_theme() +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(-1, 1)) +
  geom_point(alpha=0.3) +
  geom_boxplot(alpha=0.3)
xint_distribution
ggsave(path="plots", filename="au_ind_guiseshift_coef_pred.png", xint_distribution, width=8, height=8, units = "in" , dpi=72)

```

```{r include=F}
au_data_ind_coef %>% ggplot(aes(y=guiseShift, x=SAscore_all, color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  # coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.5) +
  geom_smooth(method='lm', se=T, alpha=0.25, fullrange=T) #+
  # facet_grid(~guise_pred)
```


```{r include=F}
au_data_ind_coef %>% ggplot(aes(y=guiseShift, x=EQscore_all, color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  # coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.5) +
  geom_smooth(method='lm', se=T, alpha=0.25, fullrange=T) #+
  # facet_grid(~guise_pred)

```

```{r include=F}
au_data_ind_coef %>% ggplot(aes(y=guiseShift, x=RTscore, color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.5) +
  geom_smooth(method='lm', se=T, alpha=0.25, fullrange=T) #+
  # facet_grid(~guise_pred)

```

```{r}
indgroups_coef <- 
  au_data_ind_coef_noBL %>% 
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high"))) #%>%
  # group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

# Facet guise + EQ
indgroups_coef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups))  %>%
  interaction_plot_theme(3) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)

# Facet EQ
indgroups_coef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups)) %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)

# No Facet
indgroups_coef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups)) %>%
  interaction_plot_theme(3) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)
  
```

### Models
```{r}
# Are the three guises different in xint? YES all differenet
ind_au_lm_guise <- lm(xint_pred ~ speakerGuise, data=au_data_ind_coef)
summary(ind_au_lm_guise)

au_data_ind_coef$guiseRelvl = relevel(au_data_ind_coef$speakerGuise, ref="CN")
ind_au_lm_guise_relvl <- lm(xint_pred ~ guiseRelvl, data=au_data_ind_coef)
summary(ind_au_lm_guise_relvl)
```


```{r}
# Are the two guises different in xint? YES, they strongly go in opposite directions
ind_au_lm <- lm(xint_pred ~ guiseContr,
                data=au_data_ind_coef_noBL)
summary(ind_au_lm)

# Are the two guises different in guiseShift? YES, CN has slightly larger effect size
ind_au_lm <- lm(guiseShift ~ guiseContr,
                data=au_data_ind_coef_noBL)
summary(ind_au_lm)
```

```{r}
# Are the size of individual guise shift effects mediated by individual SA / EQ score? 

# Basic model: A little bit
ind_au_lm <- lm(guiseShift ~ SAscore_all * EQscore_all,
                data=au_data_ind_coef_noBL)
summary(ind_au_lm)
```

```{r}
# Medium model: A little more --- After accounting for the variation in guise
ind_au_lm <- lm(guiseShift ~ guiseContr + SAscore_all * EQscore_all +
                  guiseContr:SAscore_all + speakerGuise:EQscore_all + 
                  guiseContr:SAscore_all:EQscore_all, 
                  data=au_data_ind_coef_noBL)
summary(ind_au_lm)
```

```{r}
# Max model: More again, after adding in other controls
ind_au_lm_coef <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                  SAscore_all * EQscore_all +
                  guiseContr:SAscore_all + guiseContr:EQscore_all + 
                  guiseContr:SAscore_all:EQscore_all, 
                  data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef)

```
#### Comparisons
These tell me what I already know from the max model.
```{r eval=F, include=F}
# Model comparison ---  Key variables

# Max model:
ind_au_lm_coef <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       SAscore_all * EQscore_all +
                       guiseContr:SAscore_all + guiseContr:EQscore_all + 
                       guiseContr:SAscore_all:EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef)

# No 3-way w/ Guise:
ind_au_lm_coef2 <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       SAscore_all * EQscore_all +
                       guiseContr:SAscore_all + guiseContr:EQscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef2, ind_au_lm_coef)

# No 2-way w/ Guise:
ind_au_lm_coef3 <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef3, ind_au_lm_coef2)

# No *key* 2-way interaction: ***Yes! Sig.***
ind_au_lm_coef4 <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       SAscore_all + EQscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef4, ind_au_lm_coef3)

# No EQ: Nope
ind_au_lm_coef5a <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       SAscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef5a, ind_au_lm_coef4)

# No SA: Nope
ind_au_lm_coef5b <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                       EQscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef5b, ind_au_lm_coef4)

# No SA or EQ: Nope
ind_au_lm_coef5c <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all, 
                     data=au_data_ind_coef_noBL)
anova(ind_au_lm_coef5c, ind_au_lm_coef4)

```

```{r}
# Model comparison --- More than max

# Max model:
ind_au_lm_coef <- lm(guiseShift ~ genderContr + scale(Age) + CEscore_all + guiseContr *
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef)

ind_au_lm_coef.F <- lm(guiseShift ~ genderContr + scale(Age) + CEscore_all + MSscore_all + guiseContr *
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef.F)

# Plus Gender model: 
ind_au_lm_coef.A <- lm(guiseShift ~ + scale(Age) + CEscore_all + genderContr + guiseContr *
                       SAscore_all * EQscore_all +
                       genderContr:SAscore_all + genderContr:EQscore_all + 
                       genderContr:SAscore_all:EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef.A)
anova(ind_au_lm_coef.A, ind_au_lm_coef)

# Plus Gender:Guise model:
ind_au_lm_coef.B <- lm(guiseShift ~ scale(Age) + CEscore_all + genderContr * guiseContr *
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef.B)
anova(ind_au_lm_coef.B, ind_au_lm_coef)
```

```{r eval=F, include=F}
# Plus CE Score
ind_au_lm_coef.C <- lm(guiseShift ~ scale(Age) + genderContr + CEscore_all * guiseContr * 
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef.C)
anova(ind_au_lm_coef.C, ind_au_lm_coef)

# Plus CE score + gender all
ind_au_lm_coef.D <- lm(guiseShift ~ scale(Age) + genderContr * CEscore_all * guiseContr * 
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_coef_noBL)
summary(ind_au_lm_coef.D)
anova(ind_au_lm_coef.D, ind_au_lm_coef)

# Plus EVERYTHING
# ind_au_lm_coef.E <- lm(guiseShift ~ scale(Age) * genderContr * CEscore_all * guiseContr *
#                        SAscore_all * EQscore_all,
#                      data=au_data_ind_coef_noBL)
# summary(ind_au_lm_coef.E)
# anova(ind_au_lm_coef.E, ind_au_lm_coef)
```

#### Prediction Plots
##### Main effects
```{r}
ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=speakerGuise, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  geom_jitter(size=5, alpha=0.75) +
  geom_boxplot(alpha=0.75) #+
  # geom_smooth(aes(x=guiseContr, y=pred_guiseShift), color="darkgrey",
              # method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

```

```{r}
ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=SAscore_all, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  facet_grid(~speakerGuise) +
  labs(x = 'Stereotype Familiarity', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

sf_plot <-
  ggplot(aes(x=SAscore_all, y=pred_guiseShift), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  labs(x = 'Stereotype Familiarity', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
sf_plot

ggsave(path="plots", filename="au_ind_sf_coef_pred.png", sf_plot, width=8, height=4, units = "in" , dpi=72)

```

```{r}
ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=EQscore_all, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  facet_grid(~speakerGuise) +
  labs(x = 'Empathy Quotient', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=EQscore_all, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

eq_plot <-
  ggplot(aes(x=EQscore_all, y=pred_guiseShift), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  labs(x = 'Empathy Quotient', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=EQscore_all, y=pred_guiseShift),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
eq_plot
ggsave(path="plots", filename="au_ind_eq_coef_pred.png", eq_plot, width=8, height=4, units = "in" , dpi=72)


```

##### Interaction
```{r}
# Check data values in prep for predictions
au_data_ind_coef_noBL %>% 
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high"))) %>%
  relocate(EQgroups, .after=Gender) %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

au_data_ind_coef_noBL %>% 
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 & EQscore_all < 0 ~ "mid-low",
                                EQgroups == 2 & EQscore_all > 0 ~ "mid-high",
                                EQgroups == 3 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) %>%
  relocate(EQgroups, .after=Gender)  %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

# str(au_data_ind_coef)
```

```{r eval=F, include=F}
# Predict on all unique combinations (Option 1)
ind_au_pred <- 
  expand.grid(
    guiseContr = unique(au_data_ind_coef_noBL$guiseContr),
    genderContr = mean(au_data_ind_coef_noBL$genderContr),
    Age = mean(au_data_ind_coef_noBL$Age),
    CEscore_all = mean(au_data_ind_coef_noBL$CEscore_all),
    SAscore_all = unique(au_data_ind_coef_noBL$SAscore_all),
    EQscore_all = c(-1.07589094, -0.05295016, 1.21527241)
  )
  
ind_au_pred$pred_xint <- predict(ind_au_lm_coef, newdata=ind_au_pred, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, newdata=ind_au_pred, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(speakerGuise = ifelse(guiseContr == -1, 'CN', 'MI')) %>%
  mutate(EQgroups = case_when(EQscore_all == -1.07589094 ~ "low",
                                EQscore_all == -0.05295016 ~ "mid",
                                EQscore_all == 1.21527241 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=indgroups_coef) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups), 
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=indgroups_coef) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups), 
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)
  
```

```{r}
# Predict on actual data : 3 groups, roughly equal sizes

# Make predictions df
ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_xint <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

  
```

```{r}
# Predict on actual data : 3 groups, roughly equal interval ranges

ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_xint <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

  
```

```{r}
# Predict on actual data : 4 groups, roughly equal sizes

ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_xint <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 4))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid-low",
                                EQgroups == 3 ~ "mid-high",
                                EQgroups == 4 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) %>%
  relocate(EQgroups, .after=Gender)

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(4) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

  
```

```{r}
# Predict on actual data : 3-4 groups, roughly equal interval ranges

ind_au_pred <- au_data_ind_coef_noBL
ind_au_pred$pred_xint <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_coef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 & EQscore_all < 0 ~ "mid-low",
                                EQgroups == 2 & EQscore_all > 0 ~ "mid-high",
                                EQgroups == 3 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) %>%
  relocate(EQgroups, .after=Gender)  #%>%
  # group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.25, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_coef_nofacet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)
  
# Facet by EQ
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_coef_facet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)

```

# .
## (alt) Fixef Ind Regression
Run individual regressions per participant and collect the intercept and slope, which would conceptually be less skewed towards the group means compared to the coefficients from the full model.

### Extract Individual Estimates
```{r}
# Function to calculate xint for one participant
calculate_xint <- function(df, id) {
  ind_data <- df %>% filter(participantId == id)
  ind_glm <- glmer(respRS ~ step + (1 | word),
                 family = "binomial", 
                 control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)),
                 data = ind_data)
  xint <- -(fixef(ind_glm)[[1]]) / fixef(ind_glm)[[2]]
}

# Function to collect all xints for participant in list
get_ind_xints <- function(df, participant_col) {
  
  participant_list <- unique(as.character(participant_col))

  ind_xints <- data.frame(participantId=as.character(NA),
                        xint_pred=as.integer(NA),
                        stringsAsFactors=FALSE)

  for (participantId in participant_list) {
    xint_pred = calculate_xint(df, participantId)
    ind_row = cbind.data.frame(participantId, xint_pred)
    ind_xints <- rbind(ind_xints, ind_row)
  }

  ind_xints <- ind_xints %>% na.omit() %>% mutate_if(is.character, as.factor)
}
```

```{r}
# Explanation: FixEf don't assume that there is an underlying structure such that "typically" if you are given a guise, your perception shifts X amount, and people will shift more or less. I am taking the view that some people do not shift regardless of guise, which is a different assumption that doesn't conform to the model predictions.

# TODO: Also collect slopes for using to check whether outliers are due to shallow/flat slope
( xints_fixef_au <- get_ind_xints(au_data_coded, au_data_coded$participantId) )
```

### Process Data + Outliers

#### Full
```{r}
Q1 <- quantile(xints_fixef_au$xint, .25)
Q3 <- quantile(xints_fixef_au$xint, .75)
IQR <- IQR(xints_fixef_au$xint)

au_data_ind_fixef_max <- au_data_coded %>% select(-step:-rt) %>%
  # Match xints to participant data
  merge(., xints_fixef_au) %>%

  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%

  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_fixef_noBL_max <- au_data_ind_fixef_max %>% filter(speakerGuise!='BL')
```

#### Reduced
```{r}
Q1 <- quantile(xints_fixef_au$xint, .25)
Q3 <- quantile(xints_fixef_au$xint, .75)
IQR <- IQR(xints_fixef_au$xint)

au_data_ind_fixef <- au_data_coded %>% select(-step:-rt) %>%
  # Match xints to participant data
  merge(., xints_fixef_au) %>%

  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  filter(xint_pred > Q1-IQR*3 & xint_pred < Q3+IQR*3) %>%

  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%

  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_fixef_noBL <- au_data_ind_fixef %>% filter(speakerGuise!='BL')

au_data_ind_fixef
summary(au_data_ind_fixef)
```

```{r}
# Check Data numbers
au_data_ind_fixef %>% group_by(experimentId, speakerGuise) %>% count() %>%
  merge(., au_data_ind_fixef %>% 
          group_by(experimentId, speakerGuise) %>% 
          summarize(across(where(is.numeric), mean))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)

au_data_ind_fixef %>% group_by(speakerGuise) %>% count() %>%
  merge(., au_data_ind_fixef %>% 
          group_by(speakerGuise) %>% 
          summarize(across(where(is.numeric), mean))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)
```

```{r}
# Check outlier removals
setdiff(au_data_ind_fixef, au_data_ind_fixef_noBL) %>% select(-Age:-guiseRelvl)
```

```{r}
# Check outlier removals
setdiff(au_data_ind_fixef_max, au_data_ind_fixef) %>% select(-Age:-guiseRelvl)
```


#### Exploratory Plots
```{r}
au_data_ind_fixef %>% 
 ggplot(aes(x=xint_pred, fill=speakerGuise, color=speakerGuise)) %>%
  guise_colors(3) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  geom_density(alpha=0.4, binwidth=0.1)
```


```{r}

xint_distribution <-
au_data_ind_fixef %>% ggplot(aes(y=xint_pred, x=speakerGuise, color=speakerGuise, fill=speakerGuise)) %>%
  guise_colors(3) +
  labs(x='Guise', y='Crossover Point', color='Guise', fill='Guise') +
  gg_theme() +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.3) +
  geom_boxplot(alpha=0.3)
xint_distribution
ggsave(path="plots", filename="au_ind_crosspoint_fixef_pred.png", xint_distribution, width=8, height=8, units = "in" , dpi=72)

xint_distribution <-
au_data_ind_fixef %>% ggplot(aes(y=guiseShift, x=speakerGuise, color=speakerGuise, fill=speakerGuise)) %>%
  guise_colors(3) +
  labs(x='Guise', y='Guise Effect', color='Guise', fill='Guise') +
  gg_theme() +
  theme(legend.position = "none") +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.3) +
  geom_boxplot(alpha=0.3)
xint_distribution
ggsave(path="plots", filename="au_ind_guiseshift_fixef_pred.png", xint_distribution, width=8, height=8, units = "in" , dpi=72)

```


```{r include=F}
au_data_ind_fixef %>% ggplot(aes(y=guiseShift, x=SAscore_all, color=speakerGuise)) %>% guise_colors(3) +
  theme_minimal() +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.5) +
  geom_smooth(method='lm', se=T, alpha=0.25, fullrange=T)
```

```{r include=F}
au_data_ind_fixef %>% ggplot(aes(y=guiseShift, x=EQscore_all, color=speakerGuise)) %>% guise_colors(3) +
  theme_minimal() +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_point(alpha=0.5) +
  geom_smooth(method='lm', se=T, alpha=0.25, fullrange=T) #+
  # facet_grid(~guise_pred)

```

```{r}
indgroups_fixef <- 
  au_data_ind_fixef_noBL %>% 
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high"))) #%>%
  # group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

# Facet guise + EQ
indgroups_fixef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups))  %>%
  interaction_plot_theme(3) +
  gg_theme() +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)

# Facet Guise
indgroups_fixef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups)) %>%
  interaction_plot_theme(3) +
  gg_theme() +
  facet_grid(~speakerGuise) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)

# Facet EQ
indgroups_fixef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups)) %>%
  interaction_plot_theme(3) +
  gg_theme() +
  facet_grid(~EQgroups) +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)

# No Facet
indgroups_fixef %>%
  ggplot(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups)) %>%
  interaction_plot_theme(3) +
  gg_theme() +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(method='lm', se=T, alpha=0.2, fullrange=T, size=2)
  
```

### Models
```{r}
# Are the three guises different in xint? 
ind_au_lm_fixef <- lm(xint_pred ~ speakerGuise, data=au_data_ind_fixef)
summary(ind_au_lm_fixef)

au_data_ind_fixef$guiseRelvl = relevel(au_data_ind_fixef$speakerGuise, ref="CN")
ind_au_lm_fixef <- lm(xint_pred ~ guiseRelvl, data=au_data_ind_fixef)
summary(ind_au_lm_fixef)
```

```{r}
# Are the two guises different in guiseShift? Not significant
ind_au_lm_fixef <- lm(guiseShift ~ guiseContr,
                      data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef)
```

```{r}
# Are the size of individual guise shift effects mediated by individual SA / EQ score? 

# Basic model: A little bit
ind_au_lm_fixef <- lm(guiseShift ~ SAscore_all * EQscore_all,
                      data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef)
```

```{r}
# Medium model: Similar
ind_au_lm_fixef <- lm(guiseShift ~ guiseContr + SAscore_all * EQscore_all +
                  guiseContr:SAscore_all + speakerGuise:EQscore_all + 
                  guiseContr:SAscore_all:EQscore_all, 
                  data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef)
```

```{r}
# Max model: A little more = small, but definitely stable
ind_au_lm_fixef <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                  SAscore_all * EQscore_all +
                  guiseContr:SAscore_all + guiseContr:EQscore_all + 
                  guiseContr:SAscore_all:EQscore_all, 
                  data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef)

```

#### Comparisons
```{r}
# Model comparison --- More than max

# Max model:
ind_au_lm_fixef <- lm(guiseShift ~ genderContr + scale(Age) + CEscore_all + guiseContr *
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef)

# ind_au_lm_fixef.F <- lm(guiseShift ~ genderContr + scale(Age) + CEscore_all + MSscore_all + guiseContr *
#                        SAscore_all * EQscore_all, 
#                      data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef.F)

# Plus Gender model: 
ind_au_lm_fixef.A <- lm(guiseShift ~ + scale(Age) + CEscore_all + genderContr + guiseContr *
                       SAscore_all * EQscore_all +
                       genderContr:SAscore_all + genderContr:EQscore_all + 
                       genderContr:SAscore_all:EQscore_all, 
                     data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef.A)
anova(ind_au_lm_fixef.A, ind_au_lm_fixef)

# Plus Gender:Guise model:
ind_au_lm_fixef.B <- lm(guiseShift ~ scale(Age) + CEscore_all + genderContr * guiseContr *
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef.B)
anova(ind_au_lm_fixef.B, ind_au_lm_fixef)
```

```{r}
# Plus CE Score
ind_au_lm_fixef.C <- lm(guiseShift ~ scale(Age) + genderContr + CEscore_all * guiseContr * 
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef.C)
anova(ind_au_lm_fixef.C, ind_au_lm_fixef)

# Plus CE score + gender all
ind_au_lm_fixef.D <- lm(guiseShift ~ scale(Age) + genderContr * CEscore_all * guiseContr * 
                       SAscore_all * EQscore_all, 
                     data=au_data_ind_fixef_noBL)
summary(ind_au_lm_fixef.D)
anova(ind_au_lm_fixef.D, ind_au_lm_fixef)

# Plus EVERYTHING
# ind_au_lm_fixef.E <- lm(guiseShift ~ scale(Age) * genderContr * CEscore_all * guiseContr * 
#                        SAscore_all * EQscore_all, 
#                      data=au_data_ind_fixef_noBL)
# summary(ind_au_lm_fixef.E)
# anova(ind_au_lm_fixef.E, ind_au_lm_fixef)
```


#### Prediction Plots
##### Main Effect
```{r}
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=guiseContr, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  geom_jitter(size=5, alpha=0.75) +
  geom_boxplot(alpha=0.75) +
  geom_smooth(aes(x=guiseContr, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

```

```{r}
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]

sf_plot <-
ggplot(aes(x=SAscore_all, y=guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  facet_grid(~speakerGuise) +
  labs(x = 'Stereotype Familiarity', y='Guise Effect', color='Guise') +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
sf_plot
ggsave(path="plots", filename="au_ind_sf_fixef_pred_byGuise.png", sf_plot, width=10, height=6, units = "in" , dpi=72)


sf_plot <-
  ggplot(aes(x=SAscore_all, y=pred_guiseShift), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  labs(x = 'Stereotype Familiarity', y='Guise Effect', color='Guise') +
  geom_point(size=5, alpha=0.75) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
sf_plot

ggsave(path="plots", filename="au_ind_sf_fixef_pred.png", sf_plot, width=8, height=4, units = "in" , dpi=72)

```

```{r}
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=EQscore_all, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  facet_grid(~speakerGuise) +
  labs(x = 'Empathy Quotient', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=EQscore_all, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
 
eq_plot <-
  ggplot(aes(x=EQscore_all, y=pred_guiseShift), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  labs(x = 'Empathy Quotient', y='Guise Effect', color='Guise') +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=EQscore_all, y=pred_guiseShift),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
eq_plot

ggsave(path="plots", filename="au_ind_eq_fixef_pred.png", eq_plot, width=8, height=4, units = "in" , dpi=72)
```


```{r include=F}
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]

ggplot(aes(x=SAscore_all, y=pred_guiseShift, color=speakerGuise), data=ind_au_pred) %>%
  guise_colors(2) +
  gg_theme() +
  facet_grid(Gender~speakerGuise) +
  geom_jitter(size=5, alpha=0.75) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift), color="grey",
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

```

##### Interaction
```{r}
# Check data values in prep for predictions
au_data_ind_fixef_noBL %>% 
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high"))) %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))

au_data_ind_fixef_noBL %>%
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 & EQscore_all < 0 ~ "mid-low",
                                EQgroups == 2 & EQscore_all > 0 ~ "mid-high",
                                EQgroups == 3 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))
# str(au_data_ind_fixef)
```

```{r}
# Predict on all unique combinations (Option 1)
ind_au_pred <- 
  expand.grid(
    guiseContr = unique(au_data_ind_fixef$guiseContr),
    genderContr = mean(au_data_ind_fixef$genderContr),
    Age = mean(au_data_ind_fixef$Age),
    CEscore_all = mean(au_data_ind_fixef$CEscore_all),
    SAscore_all = unique(au_data_ind_fixef$SAscore_all),
    EQscore_all = c(-1.07245952, -0.01941778, 1.25469619)
  )
  
ind_au_pred$pred_xint <- predict(ind_au_lm_fixef, newdata=ind_au_pred, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, newdata=ind_au_pred, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(speakerGuise = ifelse(guiseContr == -1, 'CN', 'MI')) %>%
  mutate(EQgroups = case_when(EQscore_all == -1.07245952 ~ "low",
                                EQscore_all == -0.01941778 ~ "mid",
                                EQscore_all == 1.25469619 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  gg_theme() +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=indgroups_fixef) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups), 
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  gg_theme() +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=indgroups_fixef) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups), 
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)
  
```

```{r}
# Predict on actual data : 3 groups, roughly equal number

ind_au_pred <- au_data_ind_fixef
ind_au_pred$pred_xint <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

  
```

```{r}
# Predict on actual data : 3 groups, roughly equal intervals

ind_au_pred <- au_data_ind_fixef
ind_au_pred$pred_xint <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid",
                                EQgroups == 3 ~ "high")) %>%
  relocate(EQgroups, .after=Gender) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid", "high")))

# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(3) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(3) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.5, fullrange=T, size=1, data=ind_au_pred)

  
```


```{r}
# Predict on actual data : 4 groups, roughly equal sizes

ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_xint <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_number(EQscore_all, 4))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 ~ "mid-low",
                                EQgroups == 3 ~ "mid-high",
                                EQgroups == 4 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) %>%
  relocate(EQgroups, .after=Gender)

# Get summary
ind_au_pred %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))


# Facet by Guise + EQ
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# Facet by EQ
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# Guise Facet
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ggplot() %>%
  interaction_plot_theme(4) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_xint, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

  
```

```{r}
# Predict on actual data : 3-4 groups, roughly equal intervals
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]
ind_au_pred <- ind_au_pred %>%
  mutate(EQgroups = as.numeric(cut_interval(EQscore_all, 3))) %>%
  mutate(EQgroups = case_when(EQgroups == 1 ~ "low",
                                EQgroups == 2 & EQscore_all < 0 ~ "mid-low",
                                EQgroups == 2 & EQscore_all > 0 ~ "mid-high",
                                EQgroups == 3 ~ "high")) %>%
  mutate(EQgroups = factor(EQgroups, levels  = c("low", "mid-low", "mid-high", "high"))) #

# Get summary
ind_au_pred %>%
  group_by(EQgroups) %>% summarize(n=n(), meanEQ = mean(EQscore_all),min = min(EQscore_all),max = max(EQscore_all), range=max(EQscore_all)-min(EQscore_all))
```

```{r}
# Facet by Guise + EQ
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_guisefacet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)


# Guise Facet
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  geom_point(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_nofacet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)

 # Facet by EQ
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_facet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)
```

```{r}
# Facet by Guise + EQ
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(speakerGuise~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_guisefacet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)


# Guise Facet
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~speakerGuise) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)

# No Facet
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups), 
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_nofacet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)

 # Facet by EQ
ind_int_plot <-
ggplot() %>%
  interaction_plot_theme(4) +
  facet_grid(~EQgroups) +
  geom_point(aes(x=SAscore_all, y=guiseShift, color=EQgroups, shape=EQgroups),
             size=5, alpha=0.75, data=ind_au_pred) +
  geom_smooth(aes(x=SAscore_all, y=pred_guiseShift, color=EQgroups, linetype=EQgroups),
              method='lm', se=T, alpha=0.3, fullrange=T, size=1, data=ind_au_pred, inherit.aes = F)
ind_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_fixef_facet_pred.png", ind_int_plot, width=12, height=8, units = "in" , dpi=72)
```

```{r}
ind_au_pred <- au_data_ind_fixef_noBL
ind_au_pred$pred_guiseShift <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[1]]
ind_au_pred$pred_se <- predict(ind_au_lm_fixef, type = "response", 
                                 re.form=NA, se=T)[[2]]

# Plot correlation
ind_au_pred %>% 
  ggplot(aes(x=SAscore_all, y=pred_guiseShift)) +
  facet_grid(~speakerGuise) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_bw()
```


# .
## Crossover Point Comparisons

```{r}
au_data_ind_xints <-
  rbind(au_data_ind_coef %>% mutate(pred_type = as.factor("coef")) %>% 
          select(-guise_pred),
        au_data_ind_fixef %>% mutate(pred_type = as.factor("fixef"))
  ) %>%
  select(participantId, experimentId, speakerGuise, guiseShift, pred_type) %>%
  pivot_wider(names_from = pred_type, values_from = guiseShift) 
au_data_ind_xints
```

```{r}
# Check correlation of model coefficients vs. individual model estimates
with(au_data_ind_xints, 
     cor.test(coef, fixef, na.rm=T))

# Plot correlation
au_data_ind_xints %>% 
  ggplot(aes(x=coef, y=fixef)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_bw()
```


```{r}
# With outlier removal
ggplot() +
  geom_point(aes(x=participantId, y=guiseShift), data=au_data_ind_coef) +
  
  geom_point(aes(x=participantId, y=guiseShift), color='blue', alpha=0.3, data=au_data_ind_fixef) +
  facet_wrap(~speakerGuise, ncol=1) +
  theme_bw()

```

```{r}
# With all data (no outlier removal)
ggplot() +
  geom_point(aes(x=participantId, y=guiseShift), data=au_data_ind_coef_max) +
  
  geom_point(aes(x=participantId, y=guiseShift), color='blue', alpha=0.3, data=au_data_ind_fixef_max) +
  facet_wrap(~speakerGuise, ncol=1) +
  theme_bw()

```

# .
## Schematic Visualizations
### Continuum Plot
```{r}
library(sigmoid)
df_noeffect <- 
  data.frame(result = "no effect",
    step = c(-5:5, -5:5, -5:5),
    speakerGuise = c(rep("BL", 11), rep("CN", 11), rep("MI", 11))) %>%
  mutate(respRS = logistic(c(rep(-5:5,3))))

df_effect <- 
  data.frame(result = "guise effect",
    step = c(-5:5, -5.5:4.5, -4.5:5.5),
    speakerGuise = c(rep("BL", 11), rep("CN", 11), rep("MI", 11))) %>%
  mutate(respRS = logistic(c(rep(-5:5,3))))

df <- rbind(df_noeffect, df_effect) %>%
  mutate(result = as.factor(result))
df$result <- relevel(df$result, ref="no effect")

mock_prop <-
  ggplot(df, aes(step, respRS, color=speakerGuise, linetype=speakerGuise)) %>%
  proportion_plot_theme() +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  facet_grid(~result) +
  geom_hline(yintercept=0.5, linetype="dotted") +
  geom_vline(xintercept=0, linetype="dotted") +
  coord_cartesian(xlim=c(-3,3)) +
  scale_x_continuous(breaks=seq(-3, 3, 1)) +
  geom_line(size=2)
mock_prop

ggsave(path="plots", filename="au_group_prop_schematic.png", mock_prop, width=16, height=6, units = "in" , dpi=72)
```


### Interaction Visualizations
```{r}

mockdata <- expand.grid(SAscore = c(-2:2),
                       #EQscore = c(-2:2),
                       EQgroup = c("high", "mid", "low"))
#mockdata

mockdata.CS <- mockdata %>% mutate(guiseShift = c(-0.2,-0.15,-0.1,-0.05,0,
                                              -0.2,-0.15,-0.1,-0.05,0,
                                              -0.2,-0.15,-0.1,-0.05,0)) %>%
  mutate(outcome = as.factor("CS.only"))

mockdata.EQ <- mockdata %>% mutate(guiseShift = c(0,0,0,0,0,
                                                -0.1,-0.1,-0.1,-0.1,-0.1,
                                                -0.2,-0.2,-0.2,-0.2,-0.2)) %>%
  mutate(outcome = as.factor("EQ.only"))

mockdata.CSEQ <- mockdata %>% mutate(guiseShift = c(0,0.05,0.1,0.15,0.2,
                                                -0.1,-0.05,0,0.05,0.1,
                                                -0.2,-0.15,-0.1,-0.05,0)) %>%
  mutate(outcome = as.factor("CS+EQ"))


mockdata.int <- mockdata %>% mutate(guiseShift = c(-0.2,-0.1,0,0.1,0.2,
                                              -0.2,-0.15,-0.1,-0.05,0,
                                              -0.2,-0.2,-0.2,-0.2,-0.2)) %>%
  mutate(outcome = as.factor("CS:EQ.int"))

mockdata.all <- mockdata.CS %>%
  rbind(., mockdata.EQ) %>%
  rbind(., mockdata.CSEQ) %>%
  rbind(., mockdata.int) %>%
  select(outcome, everything())
#mockdata.all

```

```{r}
# Predicted slopes alone

mock_int_plot <- ggplot(mockdata.all, aes(x=SAscore, y=guiseShift, color=EQgroup, linetype=EQgroup)) +
  gg_theme() +
  geom_line(size = 1) +
  facet_grid(~outcome) + 
  coord_cartesian(ylim=c(-.22, 0.22)) +
  #scale_y_continuous(breaks=c(-0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3)) +
  
  labs(y="Guise Effect", x = "Sterotype Familiarity", color="Empathy Quotient", linetype="Empathy Quotient") +
  scale_color_manual(values=ghibli_palette("MononokeMedium")[c(5,6,7)])+
  theme(plot.title = (element_text(face = "bold", hjust=0.5, size=15))) 
mock_int_plot

ggsave(path="plots", filename="au_ind_guiseshift_schematic.png", mock_int_plot, width=16, height=6, units = "in" , dpi=72)
```

# ...

## Continuous Step Regression
### Bayesian (brm)

#### Models
```{r}
prior1 <- prior(normal(0,5), class = b)

## First run on 3/11 ##
# cont_au_bm <- brm(respRS ~ step + speakerGuise + step:speakerGuise +
#                        (1 | participantId) + (0 + step | participantId) +
#                        (1 | word) + (0 + step | word),
#                     data = au_data_coded,
#                     family = 'bernoulli',
#                     prior = prior1,
#                     control = list(adapt_delta = 0.99), # default is 0.8
#                     cores=4)

summary(cont_au_bm)
```

#### Extract Group Estimates
```{r}
fixef_au <- fixef(cont_au_bm)
```

```{r}
# Calculate intercepts per guise
( int_bl <- fixef_au[[1]] )
( int_cn <- int_bl + fixef_au[[3]] )
( int_mi <- int_bl + fixef_au[[4]] )

# Calculate slopes per guise
( slope_bl <- fixef_au[[2]] )
( slope_cn <- slope_bl + fixef_au[[5]] )
( slope_mi <- slope_bl + fixef_au[[6]] )

```

```{r}
# Double check intercept values to guise means
au_data_coded %>% group_by(speakerGuise) %>%
  summarize(propRS = mean(respRS), logOddsRS = logit_scaled(mean(respRS))) %>%
  mutate(intercepts = c(int_bl, int_cn, int_mi),
         slopes = c(slope_bl, slope_cn, slope_mi)) %>%
  mutate(mean_int_diff = intercepts - logOddsRS)

```

```{r}
# Calculate x-intercepts per guise, i.e., where y=0, using the formula [y = ax + b]  ~  [x = -b/a]
( xint_bl = -(int_bl / slope_bl) )
( xint_cn = -(int_cn / slope_cn) )
( xint_mi = -(int_mi / slope_mi) )

```

#### Prediction Plots

```{r eval=F, include=F}
# Predict on original/actual data (Option 2: LogOdds)
cont_au_pred_actual <-
  filter(axb_data_coded, vowel=='AU') %>%
  mutate(predictions =  predict(cont_au_bm, type = "link") )
# cont_au_pred_actual

cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, color=speakerGuise)) %>% 
  guise_colors(3) +
  theme_minimal() +
  geom_smooth(method="glm", se=T) +
  # geom_point(alpha=0.1) +
  geom_vline(xintercept = xint_bl) +
  geom_vline(xintercept = xint_cn) +
  geom_vline(xintercept = xint_mi) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")

```

```{r eval=F, include=F}
# Predict on original/actual data (Option 2: Proportions)
cont_au_pred_actual <-
  filter(axb_data_coded, vowel=='AU') %>%
  mutate(predictions =  predict(cont_au_bm, type = "response") )
# cont_au_pred_actual

au_pred_plot <-
cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, 
                                   color=speakerGuise, fill=speakerGuise, linetype=speakerGuise)) %>% 
  proportion_plot_theme() +
  facet_grid(~vowel) +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  coord_cartesian(ylim = c(0.15, 0.85)) + 
  geom_smooth(method="loess", se=T, alpha=0.5)
au_pred_plot

ggsave(path="plots", filename="au_group_prop_nocross_pred.png", au_pred_plot, width=12, height=8, units = "in" , dpi=72)

au_pred_plot <-
cont_au_pred_actual %>% ggplot(aes(x=step, y=predictions, 
                                   color=speakerGuise, fill=speakerGuise, linetype=speakerGuise)) %>% 
  proportion_plot_theme() +
  facet_grid(~vowel) +
  scale_linetype_manual(values=c("dotdash", "longdash", "solid")) +
  scale_y_continuous(breaks=seq(0,1,0.1)) +
  coord_cartesian(ylim = c(0.15, 0.85)) + 
  geom_smooth(method="loess", se=T, alpha=0.5) +
  # geom_point(alpha=0.1) + 
  geom_vline(xintercept = xint_bl, linetype="solid") +
  geom_vline(xintercept = xint_cn, linetype="dashed") +
  geom_vline(xintercept = xint_mi, linetype="dashed")
au_pred_plot

ggsave(path="plots", filename="au_group_prop_cross_pred.png", au_pred_plot, width=12, height=8, units = "in" , dpi=72)
```

# .
## Coef Ind Regression
### Extract Individual Estimates
For these calculations:
* yint_bl = Intercept
* slope_bl = step
* yint_cn = Intercept + guiseCN
* slope_cn = step + step.guiseCN
* xint_bl = yint_bl / slope_bl
* xint_cn = yint_cn / slope_cn

```{r}
# Extract individual coefficients (based on random effects)
# ranef_au_bm <- ranef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'Intercept']

coef_au_yint_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'Intercept']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "intercept_E", .x))

coef_au_slope_bm <- coef_au_yint_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'step']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "step_E", .x))

coef_au_cn_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'speakerGuiseCN']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "speakerGuiseCN_E", .x))

coef_au_mi_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'speakerGuiseMI']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "speakerGuiseMI_E", .x))

coef_au_slopecn_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'step:speakerGuiseCN']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "step.speakerGuiseCN_E", .x))

coef_au_slopemi_bm <- data.frame(
  coef(cont_au_bm)[['participantId']][,c('Estimate', 'Est.Error'), 'step:speakerGuiseMI']
  ) %>% rownames_to_column("participantId") %>%
  rename_all(~ sub("^E", "step.speakerGuiseMI_E", .x))
```

```{r warnings=F}
# Process coefficients
coef_au_bm <- coef_au_yint_bm %>%
  merge(., coef_au_slope_bm) %>%
  merge(., coef_au_cn_bm) %>%
  merge(., coef_au_mi_bm) %>%
  merge(., coef_au_slopecn_bm) %>%
  merge(., coef_au_slopemi_bm)
```


```{r warnings=F}
xints_coef_au_bm <- coef_au_bm %>%
  # Calculate xints per guise per individual (i.e., predicted patterns per guises that they didn't see)
  mutate(xint_bl = -(intercept_Estimate / step_Estimate),
         xint_cn = -((intercept_Estimate + speakerGuiseCN_Estimate) / 
                       (step_Estimate + step.speakerGuiseCN_Estimate)),
         xint_mi = -((intercept_Estimate + speakerGuiseMI_Estimate) / 
                       (step_Estimate + step.speakerGuiseMI_Estimate))) %>%
  select(participantId, xint_bl, xint_cn, xint_mi) %>%
  pivot_longer(., xint_bl:xint_mi, names_to="guise_pred", names_prefix="xint_", values_to="xint_pred", 
               names_transform = list(guise_pred = toupper)) %>%
  mutate_if(is.character,as.factor)
xints_coef_au_bm
```


#### Exploratory Plots (1)
```{r}
xints_coef_au_bm %>%
  ggplot(aes(x=participantId, y=xint_pred, color=guise_pred)) %>%
  guise_colors(3) +
  geom_point(alpha=0.5) +
  theme(axis.text.x =  element_blank()) +
  facet_wrap(~guise_pred) +
  coord_cartesian(ylim=c(-2, 2))
```


```{r}
xints_coef_au_bm %>%
 ggplot(aes(y=participantId, x=xint_pred, color=guise_pred)) %>% 
  guise_colors(3) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  xlim(-2,2) +
  geom_vline(xintercept = xint_bl) +
  geom_vline(xintercept = xint_cn) +
  geom_vline(xintercept = xint_mi) +
  geom_point(alpha=0.5)  

```

```{r}
xints_coef_au_bm %>% ggplot(aes(y=xint_pred, x=guise_pred, color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  coord_cartesian(ylim=c(-3, 3)) +
  geom_jitter(alpha=0.5) +
  geom_boxplot(alpha=0.8)
  
xints_coef_au_bm %>% ggplot(aes(x=xint_pred, y=reorder(guise_pred, desc(guise_pred)), color=guise_pred)) %>% guise_colors(3) +
  theme_minimal() +
  labs(y="guise_pred") +
  coord_cartesian(xlim=c(-3, 3)) +
  geom_jitter(alpha=0.3) +
  geom_boxplot(alpha=0.8)
  # geom_violin(alpha=0.8)

  
```

### Process Data + Outliers
#### V1: No Outlier removal
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v1 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  # filter(xint_pred > Q1-IQR*4 & xint_pred < Q3+IQR*4) %>%

  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v1 <- au_data_ind_coef_bm_v1 %>% filter(speakerGuise!='BL')
```

#### V2: Extreme Outliers (8)
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v2 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  filter(xint_pred > Q1-IQR*8 & xint_pred < Q3+IQR*8) %>%

  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v2 <- au_data_ind_coef_bm_v2 %>% filter(speakerGuise!='BL')
```

#### V3: Liberal Outliers (6)
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v3 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  # filter(xint_pred > Q1-IQR*4 & xint_pred < Q3+IQR*4) %>%
  filter(xint_pred > Q1-IQR*4 & xint_pred < Q3+IQR*4) %>%
  
  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v3 <- au_data_ind_coef_bm_v3 %>% filter(speakerGuise!='BL')
```

#### V4: Intermediate Outliers (3)
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v4 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  # filter(xint_pred > Q1-IQR*4 & xint_pred < Q3+IQR*4) %>%
  filter(xint_pred > Q1-IQR*3 & xint_pred < Q3+IQR*3) %>%
  
  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v4 <- au_data_ind_coef_bm_v4 %>% filter(speakerGuise!='BL')
```

#### V5: Conservative Outliers (2)
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v5 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  filter(xint_pred > Q1-IQR*2 & xint_pred < Q3+IQR*2) %>%
  
  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v5 <- au_data_ind_coef_bm_v5 %>% filter(speakerGuise!='BL')
```

#### V6: Standard Outliers (1.5)
```{r}
Q1 <- quantile(xints_coef_au_bm$xint_pred, .25)
Q3 <- quantile(xints_coef_au_bm$xint_pred, .75)
IQR <- IQR(xints_coef_au_bm$xint_pred)

au_data_ind_coef_bm_v6 <- au_data_coded %>% 
  
  select(-step:-rt) %>% 
  # Match xints to participant data
  merge(., xints_coef_au_bm) %>%
  # merge(., rtscores) %>%
  
  # Filter out BL participants and predictions (for now..., may use for comparison or calculating measure)
  # filter(speakerGuise!='BL') %>%
  
  # Keep only the xint values of the guise that participants actually were assigned/completed
  filter(speakerGuise == guise_pred) %>%
  
  # Remove outliers of xint values beyond 1.5x the IQR (there are a few extreme outliers)
  filter(xint_pred > Q1-IQR*1.5 & xint_pred < Q3+IQR*1.5) %>%
  
  # Create normalized guise bias/shift effect size score
  mutate(guiseShift = ifelse(speakerGuise == 'CN', -xint_pred, xint_pred)) %>%
  
  # Remove extra rows by summarizing
  distinct() %>%
  droplevels()

au_data_ind_coef_bm_noBL_v6 <- au_data_ind_coef_bm_v6 %>% filter(speakerGuise!='BL')
```

```{r}
# Check BL removals
setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_noBL_v1)

setdiff(au_data_ind_coef_bm_v2, au_data_ind_coef_bm_noBL_v2)

setdiff(au_data_ind_coef_bm_v3, au_data_ind_coef_bm_noBL_v3)

setdiff(au_data_ind_coef_bm_v4, au_data_ind_coef_bm_noBL_v4)

setdiff(au_data_ind_coef_bm_v5, au_data_ind_coef_bm_noBL_v5)
```

```{r}
# Check outlier removals
setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_v2) %>% select(-Age:-guise_pred)

setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_v3) %>% select(-Age:-guise_pred)

setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_v4) %>% select(-Age:-guise_pred)

setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_v5) %>% select(-Age:-guise_pred)

setdiff(au_data_ind_coef_bm_v1, au_data_ind_coef_bm_v6) %>% select(-Age:-guise_pred)
```

```{r}
# Check Data numbers
au_data_ind_coef_bm %>% group_by(speakerGuise) %>% count() %>%
  merge(., au_data_ind_coef_bm %>% 
          group_by(speakerGuise) %>% 
          summarize(across(where(is.numeric), mean))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)

au_data_ind_coef_bm %>% group_by(speakerGuise) %>% count() %>%
  merge(., au_data_ind_coef_bm %>% 
          group_by(speakerGuise) %>% 
          summarize(across(where(is.numeric), min))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)

au_data_ind_coef_bm %>% group_by(speakerGuise) %>% count() %>%
  merge(., au_data_ind_coef_bm %>% 
          group_by(speakerGuise) %>% 
          summarize(across(where(is.numeric), max))
        ) %>% select(-MSscore_all, -guiseCN:-genderContr)
```


#### Exploratory Plots (2)
```{r}
au_data_ind_coef_bm_v3 %>% 
 ggplot(aes(x=xint_pred, fill=speakerGuise, color=speakerGuise)) %>%
  guise_colors(3) +
  theme_minimal() +
  theme(axis.text.y = element_blank()) +
  geom_density(alpha=0.4, binwidth=0.1) #+
  # coord_cartesian(xlim=c(-2, 2))
```


### Models

```{r}
# Are the three guises different in xint? YES all differenet
ind_au_lm_guise_bm <- lm(xint_pred ~ speakerGuise, data=au_data_ind_coef_bm_v3)
summary(ind_au_lm_guise_bm)

au_data_ind_coef_bm$guiseRelvl = relevel(au_data_ind_coef_bm$speakerGuise, ref="CN")
ind_au_lm_guise_bm_relvl <- lm(xint_pred ~ guiseRelvl, data=au_data_ind_coef_bm_v3)
summary(ind_au_lm_guise_bm_relvl)
```

```{r}
# Are the two guises different in xint? YES, they strongly go in opposite directions
ind_au_lm <- lm(xint_pred ~ guiseContr,
                data=au_data_ind_coef_bm_noBL_v3)
summary(ind_au_lm)

# Are the two guises different in guiseShift? YES, CN has slightly larger effect size
ind_au_lm <- lm(guiseShift ~ guiseContr,
                data=au_data_ind_coef_bm_noBL_v3)
summary(ind_au_lm)
```

```{r}
# Max model: More again, after adding in other controls
ind_au_lm_coef_bm <- lm(guiseShift ~ guiseContr + genderContr + scale(Age) + CEscore_all + 
                  SAscore_all * EQscore_all +
                  guiseContr:SAscore_all + guiseContr:EQscore_all + 
                  guiseContr:SAscore_all:EQscore_all, 
                  data=au_data_ind_coef_bm_noBL_v6)
summary(ind_au_lm_coef_bm)

```